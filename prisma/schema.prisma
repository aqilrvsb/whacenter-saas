// Prisma schema for Whacenter SaaS - PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  devices   Device[]
  campaigns Campaign[]
  sequences Sequence[]

  @@map("users")
}

model Device {
  id               String   @id @default(uuid())
  userId           String
  name             String
  whacenterDeviceId String  @unique
  status           String   @default("disconnected")
  qrCode           String?
  minDelaySeconds  Int      @default(3)
  maxDelaySeconds  Int      @default(7)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]
  campaigns Campaign[]

  @@index([userId])
  @@map("devices")
}

model Campaign {
  id          String   @id @default(uuid())
  userId      String
  deviceId    String
  title       String
  message     String
  status      String   @default("draft")
  totalLeads  Int      @default(0)
  sentCount   Int      @default(0)
  failedCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  device   Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  messages Message[]
  leads    Lead[]

  @@index([userId])
  @@index([deviceId])
  @@map("campaigns")
}

model Sequence {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  steps SequenceStep[]
  subscribers SequenceSubscriber[]

  @@index([userId])
  @@map("sequences")
}

model SequenceStep {
  id         String   @id @default(uuid())
  sequenceId String
  stepNumber Int
  message    String
  delayHours Int      @default(24)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sequence Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@map("sequence_steps")
}

model SequenceSubscriber {
  id            String   @id @default(uuid())
  sequenceId    String
  phone         String
  currentStep   Int      @default(0)
  status        String   @default("active")
  lastMessageAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sequence Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([phone])
  @@map("sequence_subscribers")
}

model Message {
  id         String   @id @default(uuid())
  deviceId   String
  campaignId String?
  phone      String
  message    String
  status     String   @default("pending")
  error      String?
  sentAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  device   Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([deviceId])
  @@index([campaignId])
  @@index([status])
  @@map("messages")
}

model Lead {
  id         String   @id @default(uuid())
  campaignId String
  phone      String
  name       String?
  data       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([phone])
  @@map("leads")
}
